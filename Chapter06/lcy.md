## RealMySQL - 6 데이터 압축

<br>

### 페이지 압축

- 페이지 압축은 "Transparent Page Compression"이라고 불린다.

- 파일을 복사하면 펀치 홀이 다시 채워져서 파일의 크기가 돌아올수 있어서 페이지 압축을 많이 사용하지 않는다.

<br>

### 테이블 압축 생성

- 테이블 압축의 단점
  - 버퍼 풀 공간 활용률이 낮음
  - 쿼리 처리 성능이 낮음
  - 빈번한 데이터 변경 시 압축률이 떨어짐
- 원본 데이터 페이지의 압축 결과가 목표 크기(KEY_BLOCK_SIZE)보다 작거나 같을 때까지 반복해서 페이지를 스플릿하는 것이다.

### KEY_BLCOK_SIZE 결정

- 압축된 결과를 예측해서 KEY_BLOCK_SIZE를 결정하는 것
- 테스트 시 innodb_cmp_per_index_enabled 시스템 변수를 ON으로 변경해야 기록된다.
- 압축 실패율이 높은면 InnoDB 버퍼풀에서 디스크로 기록되기 전에 압축하는 과정에 꽤 오랜 시간이 걸릴 것이라고 추측된다.
- 압축 실패율이 높다고 해서, 실제 디스크의 데이터 파일의 크키가 줄지 않지는 않는다.
- 테이블 압축은 zlib를 이용해 압축을 실행하는데, 예상외로 압축 알고리즘은 많은 CPU 자원을 소모한다는 것을 기억

### 압축된 페이지의 버퍼 풀 적재 및 사용

- 압축된 데이터 페이지를 버퍼 풀에 적재하면 압축된 상태와 압축이 해제된 상태 2개 버전을 관리한다.
- LRU 리스트와 압축된 페이지들의 압축 해제 버전인 Unzip_LRU리스트를 별도 관리한다.
- InnoDB 스토리지 엔진은 압축된 테이블에 대해서는 버퍼 풀의 공간을 이중으로 사용함으로써 메모리를 낭비하는 효과를 가진다.

### 테이블 압축 관련 설정

- innodb_cmp_per_index_enabled: 테이블 압축이 사용된 테이블의 모든 인덱스별로 압축 성공 및 압축 실행 횟수를 수집하도록 설정한다.
- innodb_compression_level: InnoDB의 테이블 압축은 zlib 압축 알고리즘만 지원하는데, 이때 시스템 변수를 이용해 압축률을 설정할 수 있다. 기본값은 6으로 숫자가 높을수록 압축률은 높아지고 속도는 느려진다.
- innodb_log_compressed_pages: InnDB 스토리지 엔진은 압축된 데이터 페이지를 그대로 리두 로그에 기록한다. 압축을 적용한 후 리두 로그 용량이 매우 빠르게 증가한다거나 더티 페이지가 많이 기록된다면 시스템 변수를 off하고 모니터링 해보면 된다. 기본값은 on인데 가능하면 on 유지 추천
