# 6.데이터 압축
- MySQL 서버의 압축 방식은 테이블 압축과 페이지 압축 두 가지 종류가 있는데, 두 동작 방식에 대해 알아보자.
## 6-1. 페이지 압축
- 페이지 압축은 MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장되고, 반대로 읽어올 때 압축이 해제된다. 즉, 버퍼 풀에 데이터 페이지가 한 번 적재되면 InnoDB 스토리지 엔진은 압축이 해제된 상태로만 데이터 페이지를 관리한다.

- 압축된 데이터의 크기를 예상할 수 없기 때문에 펀치홀이라는 기능을 사용한다. 데이터 페이지의 크기가 16kb, 압축된 데이터가 7kb로 가정하면 운영체제에서 디스크에 7kb를 기록하고 9kb의 펀치홀을 생성한다(MySQL 서버에도 기록). 디스크는 7kb의 공간만 차지하고 9kb는 운영체제에 반납한다.

- 운영체제뿐만 아니라 하드웨어도 기능을 지원해야하며, cp 또는 XtraBackup같은 툴이 복사할 경우 원본 크기로 복사될 수 있어서 잘 사용하지 않는다.

## 6-2. 테이블 압축
- 장점
    - 운영체제, 하드웨어에 대한 제약 없이 사용 가능하다.
- 단점
    - 버퍼 풀 공간 활용률이 낮음
    - 쿼리 처리 성능이 낮음
    - 빈번한 데이터 변경 시 압축률이 떨어짐

### 압축 테이블 생성
- 테이블 압축을 사용하기 위한 별도의 테이블 공간이 필요
    - innodb_file_per_table 시스템 변수 on 해야함
    - 압축된 페이지의 타깃 크기는 2n(n>=2)으로만 설정할 수 있다.
    - KEY_BLOCK_SIZE로 kb 단위 설정 가능

- 테이블 압축은 설정 단위만큼 페이지를 스플릿한 후에 InnoDB I/O 레이어를 통과한다. 목표 크기를 잘못 설정할 경우 서버의 처리 성능이 급격히 저하할 수 있다.

## KEY_BLOCK_SIZE 결정
- KEY_BLOCK_SIZE를 4, 8kb로 설정하고 압축률을 보면 적절할지 판단할 수 있는 기준이 된다.
    - 압축 실패율이 높다고 해서 적절하지 않은 것은 아니다. 로그 파일처럼 변경되지 않는 데이터는 압축하면 큰 손해는 아니다. 테이블 데이터가 빈번하게 조회 및 변경된다면 압축은 고려하지 않는 것이 좋다.
- 일반적으로 실패율은 3~5% 미만으로 유지할 수 있게 KEY_BLOCK_SIZE를 선택하는 것이 좋다.

### 압축된 페이지의 버퍼 풀 적재 및 사용
- InnoDB 스토리지 엔진은 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면, 디스크에서 읽은 상태 그대로의 데이터 페이지 목록을 관리하느 LRU 리스트와 압축된 페이지들의 압축 해제 버전인 Unzip_LRU 리스트를 별도로 관리한다.
    - 압축이 적용되지 않은 테이블의 데이터 페이지
    - 압축이 적용되 테이블의 압축된 데이터 페이지

- 데이터 페이지 관리 단점
    - 압축된 테이블에 대해서는 버퍼 풀의 공간을 이중으로 사용함으로써 메모리를 낭비하는 효과를 가진다.
    - 압축된 페이지에서 데이터 조회 및 변경하려면 압축을 해제해야 하는데, CPU를 상대적으로 많이 소모한다.

- 패턴에 따른 처리 수행
    - InnoDB 버퍼 풀 공간이 필요한 경우 LRU 압축된 데이터(원본)은 유지하고, Unzip_LRU의 압축 해제된 버전은 제거한다.
    - 압축된 데이터 페이지가 자주 사용된다면 Unzip_LRU에 계속 유지하여 압축 및 압축 해제 작업을 최소화 한다.
    - 압축된 데이터가 사용되지 않아서 LRU 리스트에서 제거된다면 Unzip_LRU에서도 함께 제거된다.

#### 정리
- CPU 사용량이 높은 서버에서는 압축 해제를 최소화하기 위해 Unzip_LRU 비율을 높여서 유지한다.
- Disk IO 사용량이 높은 서버에서는 Unzip_LRU 리스트 비율을 낮춰서 버퍼 풀 공간을 확보하도록 동작한다.