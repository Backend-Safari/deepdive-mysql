# InnoDB 스토리지 엔진 아키텍처

## MVCC(Multi Version Concurrency Control)
- 레코드 레벨의 트랜잭션을 지원하는 DBMS가 제공하는 기능이다.
- MySQL 서버의 시스템 변수에 설정된 결리수준에 따라 조회되는 데이터가 다르다.


## 잠금 없는 일관된 읽기
- InnoDB에서는 변경되기 전의 데이터를 읽기 위해 언두로그를 사용한다.
- 격리수준에 따라 읽기 명령의 값이 달라짐

## 자동 데드락 감지
- 데드락 상태를 확인하기 위하여 잠금 대기 목록을 그래프(wait-for-List) 형태로 관리한다.
- 트랜젝션을 종료할때는 언두로그 양을 제일 적게 갖고있는 것을 종료한다.
- 데드락 감지 스레드는 잠금 목록이 저장된 리스트에 새로운 잠금을 걸고 데드락 스레드를 찾게 된다.
- 이런 문제를 해결하기 위해 MySQL 서버는 innodb_deadlock_detect 시스템 변수 제공하고, off 하면 데드락 감지 스레드는 작동하지 않는다.
## 자동화된 장애 복구
- 자동 복구가 불가능한 경우 복구를 멈추고 MySQL 서버를 강제종료
- innodb_force_recovery 설정값을 1~6까지 변경하면서 MySQL을 재시작 해본다.

### 버퍼 풀의 크기 설정
- InnoDB 버퍼 풀의 크기를 적절히 작은 값으로 설정해서 조금씩 상황을 봐 가면서 증가하는 방법이 최적이다.
- innodb_buffer_pool_instances 시스템 변수를 이용해 버퍼 풀을 여러 개로 분리해서 관리할 수 있다.

### 버퍼 풀의 구조
- 버퍼 풀의 페이지 크기 조각을 관리하기 위해 InnoDB 스토리지 엔진은 크게 LRU 리스트와 플러시 리스트, 프리 리스트라는 3개의 자료 구조를 관리한다.
- InnoDB 스토리지 엔진에서 데이터를 찾는 과정은 다음과 같다.

  1. 필요한 레코드가 저장된 데이터 페이지가 버퍼 풀에 있는지 검사
  2. 디스크에서 필요한 데이터 페이지를 버퍼 풀에 적재하고, 적재된 페이지에 대한 포인터를 LRU 헤더 부분에 추가
  3. 버퍼 풀의 LRU 헤더 부분에 적재된 데이터 페이지가 실제로 읽히면 MRU 헤더 부분으로 이동
  4. 버퍼 풀에 상주하는 데이터 페이지는 사용자 쿼리가 얼마나 최근에 접근했었는지에 따라 나이가 부여되며, 버퍼 풀에 상주하는 동안 쿼리에서 오랫동안 사용되지 않으면 데이터 페이지에 부여된 나이가 오래되고 결국 해당 페이지는 버퍼 풀에서 제거된다. 버퍼 풀의 데이터 페이지가 쿼리에 의해 사용되면 나이가 초기화 되어 다시 젊어지고 MRU의 헤더 부분으로 옮겨진다.
  5. 필요한 데이터가 자주 접근됐다면 해당 페이지의 인덱스 키를 어댑티브 해시 인덱스에 추가

### Double Write Buffer
- Doubele Write 버퍼는 데이터의 안정성을 위해 자주 사용된다.
- 데이터의 무결성이 매우 중요한 서비스에서는 DoubleWrite의 활성화를 고려하는 것이 좋다.

### 언두 테이블 스페이스 권리
- InnoDB 스토리지 엔진은 트랜잭션과 격리 수준을 보장하기 위해 DML(Insert, Update, Delete)로 변경되기 이전 버전의 데이터를 별도로 백업한다.
- 이렇게 백업된 데이터를 언두 로그라고 한다.
- CREATE UNDO TABLESPACE나 DROP TABLESPACE과 같은 명령으로 새로운 언두 테이블 스페이스를 동적으로 추가하고 삭제할 수 있게 개선됐다.

### 리두 로그 및 로그 버퍼
- 리두로그는 트랜잭션의 4가지 요소인 ACID 중에서 D(Durable)에 해당하는 영속성과 가장 밀접하게 연관돼 있다.
- InnoDB 스토리지 엔진의 리두 로그 파일들의 전체 크기는 InnoDB 스토리지 엔진이 가지고 있는 버퍼 풀의 표율성을 결정하기 때문에 신주히 결정해야 한다.
- 리두 로그를 비활성화 해서 데이터의 적재 시간을 단축시킬 수 있다.
```sql
mysql> AlTER INSTANCE DISABLE INNODB REDO_LOG;

-- // 리두 로그를 비활성화 한 후 대량 데이터 적재를 실행
mysql> LOAD DATA ...

mysql> ALTER INSTANCE ENABLE INNODB REDO_LOG;
```

### InnoDB와 MyISAM, MEMORY 스토리지 엔진비교
- MySQL 서버의 모든 기능을 InnoDB 스토리지 엔진만으로 구현할 수 있게 됐다.
- MEMORY 스토리지 엔진 또한 동시 처리 성능에 있어서 InnoDB 스토리지 엔진을 따라갈 수 없다.
- internal_tmp_mem_storage_engine 시스템 변수의 기본값은 TempTable인데 MEMORY 스토리지 엔진을 선택할 수 있으나 변경 장점이 없다.

